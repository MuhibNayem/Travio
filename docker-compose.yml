# Travio Development Docker Compose
# Run with: docker compose --env-file .env.dev up --build -d

services:
  # ===========================================
  # Infrastructure Services
  # ===========================================

  postgres:
    image: postgres:16-alpine
    container_name: travio-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_MULTIPLE_DATABASES: "travio_identity,travio_catalog,travio_inventory,travio_order,travio_payment,travio_fulfillment,travio_pricing,travio_notification,travio_operator,travio_subscription,travio_fraud,travio_queue,travio_events,travio_crm,travio_fleet"
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./server/scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
      - ./server/scripts/create-multiple-postgresql-databases.sh:/docker-entrypoint-initdb.d/create-multiple-postgresql-databases.sh:ro
      - ./server/scripts/seed-bd-stations.sql:/docker-entrypoint-initdb.d/seed-bd-stations.sql:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: travio-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5

  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: travio-opensearch
    environment:
      - node.name=opensearch-node1
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600"
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.11.0
    container_name: travio-dashboards
    ports:
      - "5601:5601"
    environment:
      - 'OPENSEARCH_HOSTS=["http://opensearch:9200"]'
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
    depends_on:
      opensearch:
        condition: service_healthy

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: travio-zookeeper
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "2181" ]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: travio-kafka
    restart: unless-stopped
    ports:
      - "${KAFKA_PORT:-9092}:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    depends_on:
      zookeeper:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "kafka-topics", "--bootstrap-server", "localhost:29092", "--list" ]
      interval: 10s
      timeout: 10s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: travio-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 30s
      timeout: 10s
      retries: 5

  scylla:
    image: scylladb/scylla:5.2.0
    container_name: travio-scylla
    restart: unless-stopped
    # Developer optimizations to reduce resource usage
    command: --smp 1 --memory 1G --overprovisioned 1 --api-address 0.0.0.0
    ports:
      - "${SCYLLA_PORT:-9042}:9042"
      - "9160:9160"
    volumes:
      - scylla_data:/var/lib/scylla
    healthcheck:
      test: [ "CMD-SHELL", "cqlsh -e 'DESCRIBE CLUSTER' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  scylla-init:
    image: scylladb/scylla:5.2.0
    container_name: travio-scylla-init
    depends_on:
      scylla:
        condition: service_healthy
    volumes:
      - ./server/scripts/init-scylla.sh:/init-scylla.sh
      - ./server/services/inventory/migrations/001_initial_schema.cql:/schemas/001_inventory.cql
      - ./server/services/fleet/migrations/001_initial_schema.cql:/schemas/002_fleet.cql
    entrypoint: [ "/bin/bash", "/init-scylla.sh", "scylla", "/schemas" ]

  clickhouse:
    image: clickhouse/clickhouse-server:24.1
    container_name: travio-clickhouse
    restart: unless-stopped
    environment:
      - CLICKHOUSE_DB=${CLICKHOUSE_DATABASE:-travio_analytics}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
    ports:
      - "8123:8123" # HTTP interface
      - "9002:9000" # Native TCP (Changed to 9002 to avoid conflict with MinIO)
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8123/ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Backend Services
  # ===========================================

  identity:
    build:
      context: ./server
      dockerfile: services/identity/Dockerfile
    container_name: travio-identity
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=travio_identity
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_ADDR=redis:${REDIS_PORT:-6379}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_EXPIRY=${JWT_ACCESS_EXPIRY}
      - JWT_REFRESH_EXPIRY=${JWT_REFRESH_EXPIRY}
      - HTTP_PORT=${IDENTITY_HTTP_PORT}
      - GRPC_PORT=${IDENTITY_GRPC_PORT}
    ports:
      - "${IDENTITY_HTTP_PORT}:${IDENTITY_HTTP_PORT}"
      - "${IDENTITY_GRPC_PORT}:${IDENTITY_GRPC_PORT}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${IDENTITY_HTTP_PORT}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  catalog:
    build:
      context: ./server
      dockerfile: services/catalog/Dockerfile
    container_name: travio-catalog
    restart: unless-stopped
    environment:
      - DB_HOST=${POSTGRES_HOST}
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=travio_catalog
      - HTTP_PORT=${CATALOG_HTTP_PORT}
      - GRPC_PORT=${CATALOG_GRPC_PORT}
      - REDIS_ADDR=redis:${REDIS_PORT}
      - SUBSCRIPTION_SERVICE_URL=subscription:${SUBSCRIPTION_GRPC_PORT:-50060}
    ports:
      - "${CATALOG_HTTP_PORT}:${CATALOG_HTTP_PORT}"
      - "${CATALOG_GRPC_PORT}:${CATALOG_GRPC_PORT}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${CATALOG_HTTP_PORT}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  inventory:
    build:
      context: ./server
      dockerfile: services/inventory/Dockerfile
    container_name: travio-inventory
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=travio_inventory
      - REDIS_URL=redis:${REDIS_PORT}
      - SCYLLA_HOSTS=${SCYLLA_HOST:-scylla}
      - HOLD_TTL_SECONDS=${HOLD_TTL_SECONDS:-600}
      - HTTP_PORT=${INVENTORY_HTTP_PORT:-8083}
      - GRPC_PORT=${INVENTORY_GRPC_PORT:-9083}
    ports:
      - "${INVENTORY_HTTP_PORT:-8083}:${INVENTORY_HTTP_PORT:-8083}"
      - "${INVENTORY_GRPC_PORT:-9083}:${INVENTORY_GRPC_PORT:-9083}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      scylla:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${INVENTORY_HTTP_PORT:-8083}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  order:
    build:
      context: ./server
      dockerfile: services/order/Dockerfile
    container_name: travio-order
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=travio_order
      - KAFKA_BROKERS=kafka:29092
      - INVENTORY_URL=inventory:${INVENTORY_GRPC_PORT:-9083}
      - PAYMENT_URL=payment:${PAYMENT_GRPC_PORT:-9085}
      - HTTP_PORT=${ORDER_HTTP_PORT:-8084}
      - GRPC_PORT=${ORDER_GRPC_PORT:-9084}
    ports:
      - "${ORDER_HTTP_PORT:-8084}:${ORDER_HTTP_PORT:-8084}"
      - "${ORDER_GRPC_PORT:-9084}:${ORDER_GRPC_PORT:-9084}"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      inventory:
        condition: service_healthy
      payment:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${ORDER_HTTP_PORT:-8084}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  payment:
    build:
      context: ./server
      dockerfile: services/payment/Dockerfile
    container_name: travio-payment
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=travio_payment
      - SSLCOMMERZ_STORE_ID=${SSLCOMMERZ_STORE_ID}
      - SSLCOMMERZ_STORE_PASSWD=${SSLCOMMERZ_STORE_PASSWD}
      - SSLCOMMERZ_SANDBOX=${SSLCOMMERZ_SANDBOX:-true}
      - HTTP_PORT=${PAYMENT_HTTP_PORT:-8085}
      - GRPC_PORT=${PAYMENT_GRPC_PORT:-9085}
      - APP_ENV=development
    ports:
      - "${PAYMENT_HTTP_PORT:-8085}:${PAYMENT_HTTP_PORT:-8085}"
      - "${PAYMENT_GRPC_PORT:-9085}:${PAYMENT_GRPC_PORT:-9085}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${PAYMENT_HTTP_PORT:-8085}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  fulfillment:
    build:
      context: ./server
      dockerfile: services/fulfillment/Dockerfile
    container_name: travio-fulfillment
    restart: unless-stopped
    environment:
      - DB_HOST=${POSTGRES_HOST}
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=travio_fulfillment
      - DB_SSLMODE=disable
      - KAFKA_BROKERS=kafka:29092
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-tickets}
      - MINIO_USE_SSL=false
      - QR_SECRET_KEY=${QR_SECRET_KEY}
      - COMPANY_NAME=${COMPANY_NAME:-Travio}
      - HTTP_PORT=${FULFILLMENT_HTTP_PORT:-8086}
      - GRPC_PORT=${FULFILLMENT_GRPC_PORT:-9086}
    ports:
      - "${FULFILLMENT_HTTP_PORT:-8086}:${FULFILLMENT_HTTP_PORT:-8086}"
      - "${FULFILLMENT_GRPC_PORT:-9086}:${FULFILLMENT_GRPC_PORT:-9086}"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${FULFILLMENT_HTTP_PORT:-8086}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  queue:
    build:
      context: ./server
      dockerfile: services/queue/Dockerfile
    container_name: travio-queue
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis:${REDIS_PORT}
      - TOKEN_SECRET=${QUEUE_TOKEN_SECRET}
      - MAX_CONCURRENT_USERS=${MAX_CONCURRENT_USERS:-1000}
      - HTTP_PORT=${QUEUE_HTTP_PORT:-8087}
      - GRPC_PORT=${QUEUE_GRPC_PORT:-9087}
    ports:
      - "${QUEUE_HTTP_PORT:-8087}:${QUEUE_HTTP_PORT:-8087}"
      - "${QUEUE_GRPC_PORT:-9087}:${QUEUE_GRPC_PORT:-9087}"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${QUEUE_HTTP_PORT:-8087}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  search:
    build:
      context: ./server
      dockerfile: services/search/Dockerfile
    container_name: travio-search
    restart: unless-stopped
    environment:
      - OPENSEARCH_URL=http://opensearch:9200
      - KAFKA_BROKERS=kafka:29092
      - REDIS_ADDR=redis:${REDIS_PORT:-6379}
      - TRIPS_INDEX=${TRIPS_INDEX:-trips}
      - STATIONS_INDEX=${STATIONS_INDEX:-stations}
      - HTTP_PORT=${SEARCH_HTTP_PORT:-8088}
      - GRPC_PORT=${SEARCH_GRPC_PORT:-9088}
    ports:
      - "${SEARCH_HTTP_PORT:-8088}:${SEARCH_HTTP_PORT:-8088}"
      - "${SEARCH_GRPC_PORT:-9088}:${SEARCH_GRPC_PORT:-9088}"
    depends_on:
      opensearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${SEARCH_HTTP_PORT:-8088}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  pricing:
    build:
      context: ./server
      dockerfile: services/pricing/Dockerfile
    container_name: travio-pricing
    restart: unless-stopped
    environment:
      - DB_HOST=${POSTGRES_HOST}
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=travio_pricing
      - HTTP_PORT=${PRICING_HTTP_PORT:-8058}
      - GRPC_PORT=${PRICING_GRPC_PORT:-50058}
    ports:
      - "${PRICING_HTTP_PORT:-8058}:${PRICING_HTTP_PORT:-8058}"
      - "${PRICING_GRPC_PORT:-50058}:${PRICING_GRPC_PORT:-50058}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${PRICING_HTTP_PORT:-8058}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  operator:
    build:
      context: ./server
      dockerfile: services/operator/Dockerfile
    container_name: travio-operator
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=travio_operator
      - HTTP_PORT=${OPERATOR_HTTP_PORT:-8059}
      - GRPC_PORT=${OPERATOR_GRPC_PORT:-50059}
    ports:
      - "${OPERATOR_HTTP_PORT:-8059}:${OPERATOR_HTTP_PORT:-8059}"
      - "${OPERATOR_GRPC_PORT:-50059}:${OPERATOR_GRPC_PORT:-50059}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${OPERATOR_HTTP_PORT:-8059}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  notification:
    build:
      context: ./server
      dockerfile: services/notification/Dockerfile
    container_name: travio-notification
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=travio_notification
      - KAFKA_BROKERS=kafka:29092
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_FROM=${SMTP_FROM}
      - HTTP_PORT=${NOTIFICATION_HTTP_PORT:-8090}
      - GRPC_PORT=${NOTIFICATION_GRPC_PORT:-9090}
    ports:
      - "${NOTIFICATION_HTTP_PORT:-8090}:${NOTIFICATION_HTTP_PORT:-8090}"
      - "${NOTIFICATION_GRPC_PORT:-9090}:${NOTIFICATION_GRPC_PORT:-9090}"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${NOTIFICATION_HTTP_PORT:-8090}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  subscription:
    build:
      context: ./server
      dockerfile: services/subscription/Dockerfile
    container_name: travio-subscription
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=travio_subscription
      - HTTP_PORT=${SUBSCRIPTION_HTTP_PORT:-8060}
      - GRPC_PORT=${SUBSCRIPTION_GRPC_PORT:-50060}
    ports:
      - "${SUBSCRIPTION_HTTP_PORT:-8060}:${SUBSCRIPTION_HTTP_PORT:-8060}"
      - "${SUBSCRIPTION_GRPC_PORT:-50060}:${SUBSCRIPTION_GRPC_PORT:-50060}"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${SUBSCRIPTION_HTTP_PORT:-8060}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  fraud:
    build:
      context: ./server
      dockerfile: services/fraud/Dockerfile
    container_name: travio-fraud
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis:${REDIS_PORT}
      - ZAI_API_KEY=${ZAI_API_KEY}
      - ZAI_BASE_URL=${ZAI_BASE_URL:-https://api.z.ai/api/paas/v4}
      - FRAUD_THRESHOLD=${FRAUD_THRESHOLD:-70}
      - FRAUD_CACHE_TTL=${FRAUD_CACHE_TTL:-5m}
      - PROFILE_ENABLED=${PROFILE_ENABLED:-true}
      - PROFILE_DEVIATION_THRESHOLD=${PROFILE_DEVIATION_THRESHOLD:-2.0}
      - FRAUD_DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/travio_fraud?sslmode=disable
      - RAG_ENABLED=${RAG_ENABLED:-true}
      - RAG_TOP_K=${RAG_TOP_K:-5}
      - RAG_SIMILARITY_THRESHOLD=${RAG_SIMILARITY_THRESHOLD:-0.7}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - OPENSEARCH_URL=http://opensearch:9200
      - GRPC_PORT=${FRAUD_GRPC_PORT:-50090}
    ports:
      - "${FRAUD_GRPC_PORT:-50090}:${FRAUD_GRPC_PORT:-50090}"
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      opensearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  reporting:
    build:
      context: ./server
      dockerfile: services/reporting/Dockerfile
    container_name: travio-reporting
    restart: unless-stopped
    environment:
      - CLICKHOUSE_HOST=clickhouse
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DATABASE:-travio_analytics}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_ENABLED=${KAFKA_ENABLED:-true}
      - SCHEDULER_ENABLED=${SCHEDULER_ENABLED:-true}
      - REPORT_BATCH_SIZE=${REPORT_BATCH_SIZE:-10000}
      - REPORT_FLUSH_INTERVAL=${REPORT_FLUSH_INTERVAL:-5s}
      - GRPC_PORT=${REPORTING_GRPC_PORT:-50091}
    ports:
      - "${REPORTING_GRPC_PORT:-50091}:${REPORTING_GRPC_PORT:-50091}"
    depends_on:
      clickhouse:
        condition: service_healthy
      kafka:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  gateway:
    build:
      context: ./server
      dockerfile: services/gateway/Dockerfile
    container_name: travio-gateway
    restart: unless-stopped
    environment:
      - IDENTITY_URL=identity:${IDENTITY_GRPC_PORT}
      - CATALOG_URL=catalog:${CATALOG_GRPC_PORT}
      - INVENTORY_URL=inventory:${INVENTORY_GRPC_PORT:-9083}
      - ORDER_URL=order:${ORDER_GRPC_PORT:-9084}
      - PAYMENT_URL=payment:${PAYMENT_GRPC_PORT:-9085}
      - FULFILLMENT_URL=fulfillment:${FULFILLMENT_GRPC_PORT:-9086}
      - QUEUE_URL=queue:${QUEUE_GRPC_PORT:-9087}
      - SEARCH_URL=search:${SEARCH_GRPC_PORT:-9088}
      - PRICING_URL=pricing:${PRICING_GRPC_PORT:-50058}
      - OPERATOR_URL=operator:${OPERATOR_GRPC_PORT:-50059}
      - SUBSCRIPTION_URL=subscription:${SUBSCRIPTION_GRPC_PORT:-50060}
      - FRAUD_URL=fraud:${FRAUD_GRPC_PORT:-50090}
      - REPORTING_URL=reporting:${REPORTING_GRPC_PORT:-50091}
      - EVENTS_URL=events:${EVENTS_SERVICE_GRPC_PORT:-9091}
      - FLEET_URL=fleet:${FLEET_GRPC_PORT:-9093}
      - CRM_URL=crm:${CRM_GRPC_PORT:-9094}
      - REDIS_URL=redis:${REDIS_PORT}
      - JWT_SECRET=${JWT_SECRET}
      - HTTP_PORT=${GATEWAY_HTTP_PORT}
    ports:
      - "${GATEWAY_HTTP_PORT}:${GATEWAY_HTTP_PORT}"
    depends_on:
      identity:
        condition: service_healthy
      catalog:
        condition: service_healthy
      events:
        condition: service_healthy
      inventory:
        condition: service_healthy
      order:
        condition: service_healthy
      payment:
        condition: service_healthy
      fulfillment:
        condition: service_healthy
      queue:
        condition: service_healthy
      search:
        condition: service_healthy
      pricing:
        condition: service_healthy
      subscription:
        condition: service_healthy
      fraud:
        condition: service_healthy
      reporting:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${GATEWAY_HTTP_PORT}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  events:
    build:
      context: ./server
      dockerfile: services/events/Dockerfile
    container_name: travio-events
    restart: unless-stopped
    environment:
      - DB_HOST=${POSTGRES_HOST}
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=travio_events
      - KAFKA_BROKERS=kafka:29092
      - HTTP_PORT=${EVENTS_HTTP_PORT:-8092}
      - GRPC_PORT=${EVENTS_SERVICE_GRPC_PORT:-9091}
    ports:
      - "${EVENTS_HTTP_PORT:-8092}:${EVENTS_HTTP_PORT:-8092}"
      - "${EVENTS_SERVICE_GRPC_PORT:-9091}:${EVENTS_SERVICE_GRPC_PORT:-9091}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${EVENTS_HTTP_PORT:-8092}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  fleet:
    build:
      context: ./server
      dockerfile: services/fleet/Dockerfile
    container_name: travio-fleet
    restart: unless-stopped
    environment:
      - DB_HOST=${POSTGRES_HOST}
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=travio_fleet
      - SCYLLA_HOST=scylla:9042
      - HTTP_PORT=${FLEET_HTTP_PORT:-8093}
      - GRPC_PORT=${FLEET_GRPC_PORT:-9093}
    ports:
      - "${FLEET_HTTP_PORT:-8093}:${FLEET_HTTP_PORT:-8093}"
      - "${FLEET_GRPC_PORT:-9093}:${FLEET_GRPC_PORT:-9093}"
    depends_on:
      postgres:
        condition: service_healthy
      scylla:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${FLEET_HTTP_PORT:-8093}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  crm:
    build:
      context: ./server
      dockerfile: services/crm/Dockerfile
    container_name: travio-crm
    restart: unless-stopped
    environment:
      - DB_HOST=${POSTGRES_HOST}
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=travio_crm
      - HTTP_PORT=${CRM_HTTP_PORT:-8094}
      - GRPC_PORT=${CRM_GRPC_PORT:-9094}
    ports:
      - "${CRM_HTTP_PORT:-8094}:${CRM_HTTP_PORT:-8094}"
      - "${CRM_GRPC_PORT:-9094}:${CRM_GRPC_PORT:-9094}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:${CRM_HTTP_PORT:-8094}/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  docs:
    image: swaggerapi/swagger-ui
    container_name: travio-docs
    ports:
      - "8001:8080"
    volumes:
      - ./docs/api/rest/openapi.yaml:/tmp/openapi.yaml
    environment:
      SWAGGER_JSON: /tmp/openapi.yaml
  # ===========================================
  # Frontend
  # ===========================================


volumes:
  postgres_data:
  redis_data:
  opensearch_data:
  minio_data:
  scylla_data:
  clickhouse_data:
