syntax = "proto3";

package identity.v1;

option go_package = "github.com/MuhibNayem/Travio/server/api/proto/identity/v1";

service IdentityService {
  rpc Register(RegisterRequest) returns (RegisterResponse);
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
  rpc Logout(LogoutRequest) returns (LogoutResponse);
  rpc CreateOrganization(CreateOrgRequest) returns (CreateOrgResponse);
  rpc GetOrganization(GetOrganizationRequest) returns (Organization);
  rpc UpdateOrganization(UpdateOrganizationRequest) returns (Organization);
  
  // Role & Member Management
  rpc ListMembers(ListMembersRequest) returns (ListMembersResponse);
  rpc UpdateUserRole(UpdateUserRoleRequest) returns (UpdateUserRoleResponse);
  rpc RemoveMember(RemoveMemberRequest) returns (RemoveMemberResponse);

  // Invites
  rpc CreateInvite(CreateInviteRequest) returns (CreateInviteResponse);
  rpc AcceptInvite(AcceptInviteRequest) returns (AcceptInviteResponse);
  rpc ListInvites(ListInvitesRequest) returns (ListInvitesResponse);
}

message RegisterRequest {
  string email = 1;
  string password = 2;
  string organization_id = 3; // Link user to an org
  string name = 4; // User full name
  CreateOrgInput new_organization = 5; // Optional: Create new
}

message CreateOrgInput {
  string name = 1;
  string address = 2;
  string phone = 3;
  string email = 4;
  string website = 5;
  string currency = 6;
}

message RegisterResponse {
  string user_id = 1;
}

message LoginRequest {
  string email = 1;
  string password = 2;
}

message LoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
}

message RefreshTokenRequest {
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  string refresh_token = 2;
  int64 expires_in = 3;
}

message LogoutRequest {
  string refresh_token = 1;
}

message LogoutResponse {}

message CreateOrgRequest {
  string name = 1;
  string plan_id = 2; // Selected SaaS plan
  string address = 3;
  string phone = 4;
  string email = 5;
  string website = 6;
  string currency = 7;
}

message CreateOrgResponse {
  string organization_id = 1;
  string currency = 2;
}

message Organization {
  string id = 1;
  string name = 2;
  string plan_id = 3;
  string address = 4;
  string phone = 5;
  string email = 6;
  string website = 7;
  string status = 8;
  string currency = 9;
  string created_at = 10;
}

message GetOrganizationRequest {
  string organization_id = 1;
}

message UpdateOrganizationRequest {
  string organization_id = 1;
  string name = 2;
  string address = 3;
  string phone = 4;
  string email = 5;
  string website = 6;
  string status = 7;
  string currency = 8;
}

// --- Member Management Messages ---

message ListMembersRequest {
  string organization_id = 1;
  int32 page = 2;
  int32 limit = 3;
}

message Member {
  string user_id = 1;
  string email = 2;
  string role = 3;
  string status = 4;
  string joined_at = 5;
}

message ListMembersResponse {
  repeated Member members = 1;
  int32 total = 2;
}

message UpdateUserRoleRequest {
  string user_id = 1;
  string new_role = 2;
  string organization_id = 3; // For validation
}

message UpdateUserRoleResponse {
  bool success = 1;
}

message RemoveMemberRequest {
  string user_id = 1;
  string organization_id = 2; // For validation
}

message RemoveMemberResponse {
  bool success = 1;
}

// --- Invite Messages ---

message CreateInviteRequest {
  string email = 1;
  string role = 2;
  string organization_id = 3;
}

message CreateInviteResponse {
  string invite_id = 1;
  string token = 2; // In real app, sent via email. Here returned for testing.
}

message AcceptInviteRequest {
  string token = 1;
  string email = 2; // Validation
  string password = 3; // New user password
  string name = 4; // Optional profile info
}

message AcceptInviteResponse {
  string user_id = 1;
  string organization_id = 2;
  string access_token = 3; // Auto-login
  string refresh_token = 4;
}

message ListInvitesRequest {
  string organization_id = 1;
}

message Invite {
  string id = 1;
  string email = 2;
  string role = 3;
  string status = 4;
  string created_at = 5;
  string token = 6; // Only shown if permissions allow (e.g. for re-sending)
}

message ListInvitesResponse {
  repeated Invite invites = 1;
}
